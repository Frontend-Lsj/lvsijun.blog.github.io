<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为 | Bablvsj's Blog</title><meta name=keywords content="Ant Design"><meta name=description content="本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 我在上一篇文章《前端AntD框架的upload组件上传图片时遇"><meta name=author content><link rel=canonical href=https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/10-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E4%BD%BF%E7%94%A8customrequest%E6%96%B9%E6%B3%95%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E8%A1%8C%E4%B8%BA/><link crossorigin=anonymous href=/assets/css/stylesheet.89e53fb10d7090a33517d83b18da1cdb3f4d7bfa546525e8b3cf5a41f9817fb5.css integrity="sha256-ieU/sQ1wkKM1F9g7GNoc2z9Ne/pUZSXos89aQfmBf7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bablvsj.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://bablvsj.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://bablvsj.github.io/img/Q.gif><link rel=apple-touch-icon href=https://bablvsj.github.io/Q.gif><link rel=mask-icon href=https://bablvsj.github.io/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为"><meta property="og:description" content="本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 我在上一篇文章《前端AntD框架的upload组件上传图片时遇"><meta property="og:type" content="article"><meta property="og:url" content="https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/10-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E4%BD%BF%E7%94%A8customrequest%E6%96%B9%E6%B3%95%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E8%A1%8C%E4%B8%BA/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-01T17:11:35+08:00"><meta property="article:modified_time" content="2020-01-01T17:11:35+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为"><meta name=twitter:description content="本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 我在上一篇文章《前端AntD框架的upload组件上传图片时遇"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"文章","item":"https://bablvsj.github.io/posts/"},{"@type":"ListItem","position":3,"name":"10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为","item":"https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/10-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E4%BD%BF%E7%94%A8customrequest%E6%96%B9%E6%B3%95%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E8%A1%8C%E4%B8%BA/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为","name":"10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为","description":"本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 我在上一篇文章《前端AntD框架的upload组件上传图片时遇","keywords":["Ant Design"],"articleBody":"本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。\n我在上一篇文章《前端AntD框架的upload组件上传图片时遇到的一些坑》中讲到：AntD 的 upload 组件有很多坑，引起了很多人的关注。折腾过的人，自然明白其中的苦楚。\n今天这篇文章，我们继续来研究 AntD 的 upload 组件的另一个坑。\n备注：本文写于2020-06-11，使用的 antd 版本是 3.13.6。\n使用 AntD 的 upload 组件做图片的上传，效果演示 因为需要上传多张图片，所以采用的是照片墙的形式。上传成功后的界面如下：\n（1）上传中：\n（2）上传成功：\n（3）图片预览：\n代码实现 首先，你需要让后台同学提供好图片上传的接口。上一篇文章中，我们是把接口调用直接写在了 标签的 action 属性当中。但如果你在调接口的时候，动作很复杂（比如根据业务要求，需要连续调两个接口才能上传图片，或者在调接口时还要做其他的事情），这个 action 方法就无法满足需求了。那该怎么做呢？\n好在 AntD 的 upload 组件给我们提供了 customRequest这个方法：\n关于customRequest 这个方法， AntD 官方并没有给出示例，他们只是在 GitHub 上给出了这样一个简短的介绍：\n但这个方法怎么用呢？用的时候，会遇到什么问题呢？AntD 官方没有说。我在网上搜了半天，也没看到比较完整的、切实可行的 Demo。我天朝地大物博，网络资料浩如烟海，AntD 可是口口声声被人们号称是天朝最好用的管理后台的样式框架。可如今，却面临这样的局面。我看着你们，满怀羡慕。\n既然如此，那我就自己研究吧。折腾了一天，总算是把 customRequest 的坑踩得差不多了。\n啥也不说了，直接上代码。\n采用 AntD框架的 upload 组件的 customRequest 方法，自定义上传行为。核心代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 import React, { PureComponent } from 'react'; import { Button, Card, Form, message, Upload, Icon, Modal, Row, Col } from 'antd'; import { connect } from 'dva'; import { queryMyData, submitData } from '../api'; import { uploadImage } from '../../utils/wq.img.upload'; import styles from '../../utils/form.less'; const FormItem = Form.Item; @Form.create() export default class PicturesWall extends PureComponent { constructor(props) { super(props); const { id } = this.props.match.params; this.state = { id, img: undefined, // 从接口拿到的图片字段 imgList: [], // 展示在 antd图片组件上的数据 previewVisible: false, previewImage: '', }; } componentDidMount() { const { id } = this.state; id \u0026\u0026 this.queryData(); } // 调接口，查询已有的数据 queryData() { const { id } = this.state; queryMyData({ id, }) .then(({ ret, data }) =\u003e { if (ret == 0 \u0026\u0026 data \u0026\u0026 data.list \u0026\u0026 data.list.length) { const item = data.list[0]; const img = data.img; const imgList = item.img ? [ { uid: '1', // 注意，这个uid一定不能少，否则展示失败 name: 'hehe.png', status: 'done', url: img, }, ] : []; this.setState({ img, imgList, }); } else { return Promise.reject(); } }) .catch(() =\u003e { message.error('查询出错，请重试'); }); } handleCancel = () =\u003e this.setState({ previewVisible: false }); // 方法：图片预览 handlePreview = (file) =\u003e { console.log('smyhvae handlePreview:' + JSON.stringify(file)); this.setState({ previewImage: file.url || file.thumbUrl, previewVisible: true, }); }; // 参考链接：https://www.jianshu.com/p/f356f050b3c9 handleBeforeUpload = (file) =\u003e { console.log('smyhvae handleBeforeUpload file:' + JSON.stringify(file)); console.log('smyhvae handleBeforeUpload file.file:' + JSON.stringify(file.file)); console.log('smyhvae handleBeforeUpload file type:' + JSON.stringify(file.type)); //限制图片 格式、size、分辨率 const isJPG = file.type === 'image/jpeg'; const isJPEG = file.type === 'image/jpeg'; const isGIF = file.type === 'image/gif'; const isPNG = file.type === 'image/png'; const isLt2M = file.size / 1024 / 1024 \u003c 1; if (!(isJPG || isJPEG || isPNG)) { Modal.error({ title: '只能上传JPG、JPEG、PNG格式的图片~', }); } else if (!isLt2M) { Modal.error({ title: '图片超过1M限制，不允许上传~', }); } return (isJPG || isJPEG || isPNG) \u0026\u0026 isLt2M; }; // checkImageWH 返回一个promise 检测通过返回resolve 失败返回reject阻止图片上传 checkImageWH(file) { return new Promise(function (resolve, reject) { let filereader = new FileReader(); filereader.onload = (e) =\u003e { let src = e.target.result; const image = new Image(); image.onload = function () { // 获取图片的宽高 file.width = this.width; file.height = this.height; resolve(); }; image.onerror = reject; image.src = src; }; filereader.readAsDataURL(file); }); } // 图片上传 doImgUpload = (options) =\u003e { const { onSuccess, onError, file, onProgress } = options; // start：进度条相关 // 伪装成 handleChange里面的图片上传状态 const imgItem = { uid: '1', // 注意，这个uid一定不能少，否则上传失败 name: 'hehe.png', status: 'uploading', url: '', percent: 99, // 注意不要写100。100表示上传完成 }; this.setState({ imgList: [imgItem], }); // 更新 imgList // end：进度条相关 const reader = new FileReader(); reader.readAsDataURL(file); // 读取图片文件 reader.onload = (file) =\u003e { const params = { myBase64: file.target.result, // 把 本地图片的base64编码传给后台，调接口，生成图片的url }; // 上传图片的base64编码，调接口后，返回 imageId uploadImage(params) .then((res) =\u003e { console.log('smyhvae doImgUpload:' + JSON.stringify(res)); console.log('smyhvae 图片上传成功：' + res.imageUrl); const imgItem = { uid: '1', // 注意，这个uid一定不能少，否则上传失败 name: 'hehe.png', status: 'done', url: res.imageUrl, // url 是展示在页面上的绝对链接 imgUrl: res.imageUrl, // imgUrl 是存到 db 里的相对链接 // response: '{\"status\": \"success\"}', }; this.setState({ imgList: [imgItem], }); // 更新 imgList }) .catch((e) =\u003e { console.log('smyhvae 图片上传失败:' + JSON.stringify(e || '')); message.error('图片上传失败，请重试'); }); }; }; handleChange = ({ file, fileList }) =\u003e { console.log('smyhvae handleChange file:' + JSON.stringify(file)); console.log('smyhvae handleChange fileList:' + JSON.stringify(fileList)); if (file.status == 'removed') { this.setState({ imgList: [], }); } }; submit = (e) =\u003e { e.preventDefault(); this.props.form.validateFields((err, fieldsValue) =\u003e { if (err) { return; } const { id, imgList } = this.state; const tempImgList = imgList.filter((item) =\u003e item.status == 'done'); // 筛选出 status = done 的图片 const imgArr = []; tempImgList.forEach((item) =\u003e { imgArr.push(item.imgUrl); // imgArr.push(item.url); }); submitData({ id, img: imgArr[0] || '', // 1、暂时只传一张图片给后台。如果传多张图片，那么，upload组件需要进一步完善，比较麻烦，以后有需求再优化。2、如果图片字段是选填，那就用空字符串兜底 }) .then((res) =\u003e { if (res.ret == 0) { message.success(`${id ? '修改' : '新增'}成功，自动跳转中...`); } else if (res.ret == 201 || res.ret == 202 || res.ret == 203 || res.ret == 6) { return Promise.reject(res.msg); } else { return Promise.reject(); } }) .catch((e) =\u003e { message.error(e || '提交失败，请重试'); }); }); }; render() { const { id, imgList } = this.state; console.log('smyhvae render imgList:' + JSON.stringify(imgList)); const { getFieldDecorator } = this.props.form; const formItemLayout = { labelCol: { span: 3 }, wrapperCol: { span: 10 }, }; const buttonItemLayout = { wrapperCol: { span: 10, offset: 3 }, }; const uploadButton = ( \u003cdiv\u003e \u003cIcon type=\"plus\" /\u003e \u003cdiv className=\"ant-upload-text\"\u003eUpload\u003c/div\u003e \u003c/div\u003e ); return ( \u003cCard title={id ? '修改信息' : '新增信息'}\u003e \u003cForm onSubmit={this.submit} layout=\"horizontal\"\u003e {/* 新建图片、编辑图片 */} \u003cFormItem label=\"图片\" {...formItemLayout}\u003e {getFieldDecorator('img', { rules: [{ required: false, message: '请上传图片' }], })( \u003cUpload action=\"2\" customRequest={this.doImgUpload} listType=\"picture-card\" fileList={imgList} onPreview={this.handlePreview} beforeUpload={this.handleBeforeUpload} onChange={this.handleChange} \u003e {imgList.length \u003e= 1 ? null : uploadButton} \u003c/Upload\u003e )} \u003c/FormItem\u003e \u003cRow\u003e \u003cCol span={3} /\u003e \u003cCol span={18} className={styles.graytext}\u003e 注：图片支持JPG、JPEG、PNG格式，小于1M，最多上传1张 \u003c/Col\u003e \u003c/Row\u003e \u003cFormItem {...buttonItemLayout}\u003e \u003cButton type=\"primary\" htmlType=\"submit\"\u003e 提交 \u003c/Button\u003e \u003c/FormItem\u003e \u003c/Form\u003e {/* 图片点开预览 */} \u003cModal visible={this.state.previewVisible} footer={null} onCancel={this.handleCancel}\u003e \u003cimg alt=\"example\" style={{ width: '100%' }} src={this.state.previewImage} /\u003e \u003c/Modal\u003e \u003c/Card\u003e ); } } 参考链接 注意file的格式：https://www.lmonkey.com/t/oREQA5XE1\nDemo在线演示：\nhttps://stackoverflow.com/questions/58128062/using-customrequest-in-ant-design-file-upload\nhttps://stackblitz.com/edit/so-58128062-upload-progress\nfileList 格式在线演示：\nhttps://stackoverflow.com/questions/51514757/action-function-is-required-with-antd-upload-control-but-i-dont-need-it\nhttps://codesandbox.io/s/rl7ooo544q\nant design Upload组件的使用总结：https://www.jianshu.com/p/0aa4612af987\nantd上传功能的CustomRequest：https://mlog.club/article/3832743\n","wordCount":"2628","inLanguage":"en","datePublished":"2020-01-01T17:11:35+08:00","dateModified":"2020-01-01T17:11:35+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/10-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E4%BD%BF%E7%94%A8customrequest%E6%96%B9%E6%B3%95%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8A%E4%BC%A0%E8%A1%8C%E4%B8%BA/"},"publisher":{"@type":"Organization","name":"Bablvsj's Blog","logo":{"@type":"ImageObject","url":"https://bablvsj.github.io/img/Q.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bablvsj.github.io accesskey=h title="Bablvsj's Blog (Alt + H)">Bablvsj's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bablvsj.github.io/ title=主页><span>主页</span></a></li><li><a href=https://bablvsj.github.io/archives/ title=时间轴><span>时间轴</span></a></li><li><a href=https://bablvsj.github.io/tags title=标签><span>标签</span></a></li><li><a href=https://bablvsj.github.io/about title=关于><span>关于</span></a></li><li><a href=https://bablvsj.github.io/search title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>10-AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为</h1><div class=post-meta><ul class=post-tags-meta><a href=https://bablvsj.github.io/tags/ant-design/>Ant Design</a></ul>6 min&nbsp;·&nbsp;<span title='2020-01-01 17:11:35 +0800 +0800'>2020/01/01</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><div class=inner><ul><li><a href=#%e4%bd%bf%e7%94%a8-antd-%e7%9a%84-upload-%e7%bb%84%e4%bb%b6%e5%81%9a%e5%9b%be%e7%89%87%e7%9a%84%e4%b8%8a%e4%bc%a0%e6%95%88%e6%9e%9c%e6%bc%94%e7%a4%ba aria-label="使用 AntD 的 upload 组件做图片的上传，效果演示">使用 AntD 的 upload 组件做图片的上传，效果演示</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0 aria-label=代码实现>代码实现</a></li><li><a href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5 aria-label=参考链接>参考链接</a></li></ul></div></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 <a href=https://ant.design/components/upload-cn/>upload</a> 组件。</p><p>我在上一篇文章《<a href=https://www.cnblogs.com/qianguyihao/p/10460834.html>前端AntD框架的upload组件上传图片时遇到的一些坑</a>》中讲到：AntD 的 upload 组件有很多坑，引起了很多人的关注。折腾过的人，自然明白其中的苦楚。</p><p>今天这篇文章，我们继续来研究 AntD 的 upload 组件的另一个坑。</p><p>备注：本文写于2020-06-11，使用的 antd 版本是 3.13.6。</p><h2 id=使用-antd-的-upload-组件做图片的上传效果演示>使用 AntD 的 upload 组件做图片的上传，效果演示<a hidden class=anchor aria-hidden=true href=#使用-antd-的-upload-组件做图片的上传效果演示>#</a></h2><p>因为需要上传多张图片，所以采用的是照片墙的形式。上传成功后的界面如下：</p><p>（1）上传中：</p><p><img loading=lazy src=http://img.smyhvae.com/20190302_1335.png alt></p><p>（2）上传成功：</p><p><img loading=lazy src=http://img.smyhvae.com/20190302_1336.png alt></p><p>（3）图片预览：</p><p><img loading=lazy src=http://img.smyhvae.com/20190302_1331.png alt></p><h2 id=代码实现>代码实现<a hidden class=anchor aria-hidden=true href=#代码实现>#</a></h2><p>首先，你需要让后台同学提供好图片上传的接口。上一篇文章中，我们是把接口调用直接写在了 <code>&lt;Upload></code> 标签的 action 属性当中。但如果你在调接口的时候，动作很复杂（比如根据业务要求，需要连续调两个接口才能上传图片，或者在调接口时还要做其他的事情），这个 action 方法就无法满足需求了。那该怎么做呢？</p><p>好在 AntD 的 upload 组件给我们提供了 <code>customRequest</code>这个方法：</p><p><img loading=lazy src=http://img.smyhvae.com/20200611_1543.png alt></p><p>关于customRequest 这个方法， AntD 官方并没有给出示例，他们只是在 GitHub 上给出了这样一个简短的介绍：</p><p><img loading=lazy src=http://img.smyhvae.com/20200611_1536.png alt></p><p>但这个方法怎么用呢？用的时候，会遇到什么问题呢？AntD 官方没有说。我在网上搜了半天，也没看到比较完整的、切实可行的 Demo。我天朝地大物博，网络资料浩如烟海，AntD 可是口口声声被人们号称是天朝最好用的管理后台的样式框架。可如今，却面临这样的局面。我看着你们，满怀羡慕。</p><p>既然如此，那我就自己研究吧。折腾了一天，总算是把 customRequest 的坑踩得差不多了。</p><p>啥也不说了，直接上代码。</p><p>采用 AntD框架的 <a href=https://ant.design/components/upload-cn/>upload</a> 组件的 customRequest 方法，自定义上传行为。核心代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=kr>import</span> <span class=nx>React</span><span class=p>,</span> <span class=p>{</span> <span class=nx>PureComponent</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Button</span><span class=p>,</span> <span class=nx>Card</span><span class=p>,</span> <span class=nx>Form</span><span class=p>,</span> <span class=nx>message</span><span class=p>,</span> <span class=nx>Upload</span><span class=p>,</span> <span class=nx>Icon</span><span class=p>,</span> <span class=nx>Modal</span><span class=p>,</span> <span class=nx>Row</span><span class=p>,</span> <span class=nx>Col</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;antd&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>connect</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;dva&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>queryMyData</span><span class=p>,</span> <span class=nx>submitData</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../api&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>uploadImage</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../../utils/wq.img.upload&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>styles</span> <span class=nx>from</span> <span class=s1>&#39;../../utils/form.less&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>FormItem</span> <span class=o>=</span> <span class=nx>Form</span><span class=p>.</span><span class=nx>Item</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>@</span><span class=nx>Form</span><span class=p>.</span><span class=nx>create</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>class</span> <span class=nx>PicturesWall</span> <span class=kr>extends</span> <span class=nx>PureComponent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>constructor</span><span class=p>(</span><span class=nx>props</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>(</span><span class=nx>props</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>match</span><span class=p>.</span><span class=nx>params</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>img</span><span class=o>:</span> <span class=kc>undefined</span><span class=p>,</span> <span class=c1>// 从接口拿到的图片字段
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>imgList</span><span class=o>:</span> <span class=p>[],</span> <span class=c1>// 展示在 antd图片组件上的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>previewImage</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>componentDidMount</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>queryData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 调接口，查询已有的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>queryData</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>queryMyData</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>then</span><span class=p>(({</span> <span class=nx>ret</span><span class=p>,</span> <span class=nx>data</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>ret</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>list</span> <span class=o>&amp;&amp;</span> <span class=nx>data</span><span class=p>.</span><span class=nx>list</span><span class=p>.</span><span class=nx>length</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>item</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>list</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>img</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>img</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>imgList</span> <span class=o>=</span> <span class=nx>item</span><span class=p>.</span><span class=nx>img</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>              <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>uid</span><span class=o>:</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=c1>// 注意，这个uid一定不能少，否则展示失败
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;hehe.png&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;done&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nx>url</span><span class=o>:</span> <span class=nx>img</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=o>:</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>img</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>imgList</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=k>catch</span><span class=p>(()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>message</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;查询出错，请重试&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleCancel</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>false</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 方法：图片预览
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>handlePreview</span> <span class=o>=</span> <span class=p>(</span><span class=nx>file</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae handlePreview:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>previewImage</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>url</span> <span class=o>||</span> <span class=nx>file</span><span class=p>.</span><span class=nx>thumbUrl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 参考链接：https://www.jianshu.com/p/f356f050b3c9
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>handleBeforeUpload</span> <span class=o>=</span> <span class=p>(</span><span class=nx>file</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae handleBeforeUpload file:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae handleBeforeUpload file.file:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae handleBeforeUpload file type:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>type</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>//限制图片 格式、size、分辨率
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>isJPG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isJPEG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isGIF</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/gif&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isPNG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/png&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isLt2M</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>size</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>isJPG</span> <span class=o>||</span> <span class=nx>isJPEG</span> <span class=o>||</span> <span class=nx>isPNG</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Modal</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;只能上传JPG、JPEG、PNG格式的图片~&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isLt2M</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Modal</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;图片超过1M限制，不允许上传~&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nx>isJPG</span> <span class=o>||</span> <span class=nx>isJPEG</span> <span class=o>||</span> <span class=nx>isPNG</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isLt2M</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// checkImageWH  返回一个promise  检测通过返回resolve  失败返回reject阻止图片上传
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>checkImageWH</span><span class=p>(</span><span class=nx>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>filereader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FileReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>filereader</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>src</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>image</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Image</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 获取图片的宽高
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>file</span><span class=p>.</span><span class=nx>width</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>file</span><span class=p>.</span><span class=nx>height</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=nx>reject</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>filereader</span><span class=p>.</span><span class=nx>readAsDataURL</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 图片上传
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>doImgUpload</span> <span class=o>=</span> <span class=p>(</span><span class=nx>options</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>onSuccess</span><span class=p>,</span> <span class=nx>onError</span><span class=p>,</span> <span class=nx>file</span><span class=p>,</span> <span class=nx>onProgress</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>options</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// start：进度条相关
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 伪装成 handleChange里面的图片上传状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>imgItem</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>uid</span><span class=o>:</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=c1>// 注意，这个uid一定不能少，否则上传失败
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;hehe.png&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;uploading&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>url</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>percent</span><span class=o>:</span> <span class=mi>99</span><span class=p>,</span> <span class=c1>// 注意不要写100。100表示上传完成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>imgList</span><span class=o>:</span> <span class=p>[</span><span class=nx>imgItem</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span> <span class=c1>// 更新 imgList
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// end：进度条相关
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FileReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>reader</span><span class=p>.</span><span class=nx>readAsDataURL</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span> <span class=c1>// 读取图片文件
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nx>reader</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=p>(</span><span class=nx>file</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>myBase64</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>,</span> <span class=c1>// 把 本地图片的base64编码传给后台，调接口，生成图片的url
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// 上传图片的base64编码，调接口后，返回 imageId
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>uploadImage</span><span class=p>(</span><span class=nx>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae doImgUpload:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>res</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae 图片上传成功：&#39;</span> <span class=o>+</span> <span class=nx>res</span><span class=p>.</span><span class=nx>imageUrl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>imgItem</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>uid</span><span class=o>:</span> <span class=s1>&#39;1&#39;</span><span class=p>,</span> <span class=c1>// 注意，这个uid一定不能少，否则上传失败
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;hehe.png&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;done&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>url</span><span class=o>:</span> <span class=nx>res</span><span class=p>.</span><span class=nx>imageUrl</span><span class=p>,</span> <span class=c1>// url 是展示在页面上的绝对链接
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>imgUrl</span><span class=o>:</span> <span class=nx>res</span><span class=p>.</span><span class=nx>imageUrl</span><span class=p>,</span> <span class=c1>// imgUrl 是存到 db 里的相对链接
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// response: &#39;{&#34;status&#34;: &#34;success&#34;}&#39;,
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=nx>imgList</span><span class=o>:</span> <span class=p>[</span><span class=nx>imgItem</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span> <span class=c1>// 更新 imgList
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae 图片上传失败:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>e</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=nx>message</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=s1>&#39;图片上传失败，请重试&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>file</span><span class=p>,</span> <span class=nx>fileList</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae handleChange file:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae handleChange fileList:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>fileList</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>file</span><span class=p>.</span><span class=nx>status</span> <span class=o>==</span> <span class=s1>&#39;removed&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>imgList</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>submit</span> <span class=o>=</span> <span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>e</span><span class=p>.</span><span class=nx>preventDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>form</span><span class=p>.</span><span class=nx>validateFields</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>fieldsValue</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>imgList</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>tempImgList</span> <span class=o>=</span> <span class=nx>imgList</span><span class=p>.</span><span class=nx>filter</span><span class=p>((</span><span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>item</span><span class=p>.</span><span class=nx>status</span> <span class=o>==</span> <span class=s1>&#39;done&#39;</span><span class=p>);</span> <span class=c1>// 筛选出 status = done 的图片
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>const</span> <span class=nx>imgArr</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>      <span class=nx>tempImgList</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>item</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>imgArr</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>item</span><span class=p>.</span><span class=nx>imgUrl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// imgArr.push(item.url);
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>submitData</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>img</span><span class=o>:</span> <span class=nx>imgArr</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=c1>// 1、暂时只传一张图片给后台。如果传多张图片，那么，upload组件需要进一步完善，比较麻烦，以后有需求再优化。2、如果图片字段是选填，那就用空字符串兜底
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>res</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>message</span><span class=p>.</span><span class=nx>success</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>id</span> <span class=o>?</span> <span class=s1>&#39;修改&#39;</span> <span class=o>:</span> <span class=s1>&#39;新增&#39;</span><span class=si>}</span><span class=sb>成功，自动跳转中...`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>ret</span> <span class=o>==</span> <span class=mi>201</span> <span class=o>||</span> <span class=nx>res</span><span class=p>.</span><span class=nx>ret</span> <span class=o>==</span> <span class=mi>202</span> <span class=o>||</span> <span class=nx>res</span><span class=p>.</span><span class=nx>ret</span> <span class=o>==</span> <span class=mi>203</span> <span class=o>||</span> <span class=nx>res</span><span class=p>.</span><span class=nx>ret</span> <span class=o>==</span> <span class=mi>6</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>msg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>Promise</span><span class=p>.</span><span class=nx>reject</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=k>catch</span><span class=p>((</span><span class=nx>e</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>message</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>e</span> <span class=o>||</span> <span class=s1>&#39;提交失败，请重试&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>imgList</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae render imgList:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>imgList</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>getFieldDecorator</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>.</span><span class=nx>form</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>formItemLayout</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>labelCol</span><span class=o>:</span> <span class=p>{</span> <span class=nx>span</span><span class=o>:</span> <span class=mi>3</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>wrapperCol</span><span class=o>:</span> <span class=p>{</span> <span class=nx>span</span><span class=o>:</span> <span class=mi>10</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>buttonItemLayout</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>wrapperCol</span><span class=o>:</span> <span class=p>{</span> <span class=nx>span</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nx>offset</span><span class=o>:</span> <span class=mi>3</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>uploadButton</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Icon</span> <span class=nx>type</span><span class=o>=</span><span class=s2>&#34;plus&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>div</span> <span class=nx>className</span><span class=o>=</span><span class=s2>&#34;ant-upload-text&#34;</span><span class=o>&gt;</span><span class=nx>Upload</span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>Card</span> <span class=nx>title</span><span class=o>=</span><span class=p>{</span><span class=nx>id</span> <span class=o>?</span> <span class=s1>&#39;修改信息&#39;</span> <span class=o>:</span> <span class=s1>&#39;新增信息&#39;</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Form</span> <span class=nx>onSubmit</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>submit</span><span class=p>}</span> <span class=nx>layout</span><span class=o>=</span><span class=s2>&#34;horizontal&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=p>{</span><span class=cm>/* 新建图片、编辑图片 */</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>FormItem</span> <span class=nx>label</span><span class=o>=</span><span class=s2>&#34;图片&#34;</span> <span class=p>{...</span><span class=nx>formItemLayout</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>getFieldDecorator</span><span class=p>(</span><span class=s1>&#39;img&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>rules</span><span class=o>:</span> <span class=p>[{</span> <span class=nx>required</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;请上传图片&#39;</span> <span class=p>}],</span>
</span></span><span class=line><span class=cl>            <span class=p>})(</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;</span><span class=nx>Upload</span>
</span></span><span class=line><span class=cl>                <span class=nx>action</span><span class=o>=</span><span class=s2>&#34;2&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nx>customRequest</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>doImgUpload</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>listType</span><span class=o>=</span><span class=s2>&#34;picture-card&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nx>fileList</span><span class=o>=</span><span class=p>{</span><span class=nx>imgList</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>onPreview</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handlePreview</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>beforeUpload</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleBeforeUpload</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=o>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=nx>imgList</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;=</span> <span class=mi>1</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>uploadButton</span><span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;</span><span class=err>/Upload&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>)}</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=err>/FormItem&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>Row</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>Col</span> <span class=nx>span</span><span class=o>=</span><span class=p>{</span><span class=mi>3</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>Col</span> <span class=nx>span</span><span class=o>=</span><span class=p>{</span><span class=mi>18</span><span class=p>}</span> <span class=nx>className</span><span class=o>=</span><span class=p>{</span><span class=nx>styles</span><span class=p>.</span><span class=nx>graytext</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nx>注</span><span class=err>：</span><span class=nx>图片支持JPG</span><span class=err>、</span><span class=nx>JPEG</span><span class=err>、</span><span class=nx>PNG格式</span><span class=err>，</span><span class=nx>小于1M</span><span class=err>，</span><span class=nx>最多上传1张</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=err>/Col&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=err>/Row&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>FormItem</span> <span class=p>{...</span><span class=nx>buttonItemLayout</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=nx>Button</span> <span class=nx>type</span><span class=o>=</span><span class=s2>&#34;primary&#34;</span> <span class=nx>htmlType</span><span class=o>=</span><span class=s2>&#34;submit&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>              <span class=nx>提交</span>
</span></span><span class=line><span class=cl>            <span class=o>&lt;</span><span class=err>/Button&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=err>/FormItem&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/Form&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>{</span><span class=cm>/* 图片点开预览 */</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Modal</span> <span class=nx>visible</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>previewVisible</span><span class=p>}</span> <span class=nx>footer</span><span class=o>=</span><span class=p>{</span><span class=kc>null</span><span class=p>}</span> <span class=nx>onCancel</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleCancel</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>img</span> <span class=nx>alt</span><span class=o>=</span><span class=s2>&#34;example&#34;</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>width</span><span class=o>:</span> <span class=s1>&#39;100%&#39;</span> <span class=p>}}</span> <span class=nx>src</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>previewImage</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/Modal&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/Card&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=参考链接>参考链接<a hidden class=anchor aria-hidden=true href=#参考链接>#</a></h2><p>注意file的格式：https://www.lmonkey.com/t/oREQA5XE1</p><p>Demo在线演示：</p><ul><li><p><a href=https://stackoverflow.com/questions/58128062/using-customrequest-in-ant-design-file-upload>https://stackoverflow.com/questions/58128062/using-customrequest-in-ant-design-file-upload</a></p></li><li><p><a href=https://stackblitz.com/edit/so-58128062-upload-progress>https://stackblitz.com/edit/so-58128062-upload-progress</a></p></li></ul><p>fileList 格式在线演示：</p><ul><li><p><a href=https://stackoverflow.com/questions/51514757/action-function-is-required-with-antd-upload-control-but-i-dont-need-it>https://stackoverflow.com/questions/51514757/action-function-is-required-with-antd-upload-control-but-i-dont-need-it</a></p></li><li><p><a href=https://codesandbox.io/s/rl7ooo544q>https://codesandbox.io/s/rl7ooo544q</a></p></li></ul><p>ant design Upload组件的使用总结：https://www.jianshu.com/p/0aa4612af987</p><p>antd上传功能的CustomRequest：https://mlog.club/article/3832743</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bablvsj.github.io/tags/ant-design/>Ant Design</a></li></ul><nav class=paginav><a class=prev href=https://bablvsj.github.io/posts/tech/wait/04-javascript/09-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E8%AF%AD%E5%8F%A5%E9%80%89%E6%8B%A9%E7%BB%93%E6%9E%84if%E5%92%8Cswitch/><span class=title>« Prev</span><br><span>09-流程控制语句：选择结构（if和switch）</span></a>
<a class=next href=https://bablvsj.github.io/posts/tech/wait/04-javascript/10-promise%E5%85%A5%E9%97%A8%E8%AF%A6%E8%A7%A3/><span class=title>Next »</span><br><span>10-Promise入门详解</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://bablvsj.github.io>Bablvsj's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div class=flex-c-d><a class=flex-d-c href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target=_blank><span>本站由</span><img width=60 src=/images/upyun.png>提供CDN加速/云存储服务</a></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>