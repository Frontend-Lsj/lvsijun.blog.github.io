<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>09-AntD框架的upload组件上传图片时遇到的一些坑 | Bablvsj's Blog</title><meta name=keywords content="Ant Design"><meta name=description content="前言 本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 前端做文件上传这个功能，是很有技术难度的。既然框架给我们提"><meta name=author content><link rel=canonical href=https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/09-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/><link crossorigin=anonymous href=/assets/css/stylesheet.89e53fb10d7090a33517d83b18da1cdb3f4d7bfa546525e8b3cf5a41f9817fb5.css integrity="sha256-ieU/sQ1wkKM1F9g7GNoc2z9Ne/pUZSXos89aQfmBf7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://bablvsj.github.io/img/Q.gif><link rel=icon type=image/png sizes=16x16 href=https://bablvsj.github.io/img/Q.gif><link rel=icon type=image/png sizes=32x32 href=https://bablvsj.github.io/img/Q.gif><link rel=apple-touch-icon href=https://bablvsj.github.io/Q.gif><link rel=mask-icon href=https://bablvsj.github.io/Q.gif><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="09-AntD框架的upload组件上传图片时遇到的一些坑"><meta property="og:description" content="前言 本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 前端做文件上传这个功能，是很有技术难度的。既然框架给我们提"><meta property="og:type" content="article"><meta property="og:url" content="https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/09-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-01-01T17:11:35+08:00"><meta property="article:modified_time" content="2020-01-01T17:11:35+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="09-AntD框架的upload组件上传图片时遇到的一些坑"><meta name=twitter:description content="前言 本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 前端做文件上传这个功能，是很有技术难度的。既然框架给我们提"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"文章","item":"https://bablvsj.github.io/posts/"},{"@type":"ListItem","position":3,"name":"09-AntD框架的upload组件上传图片时遇到的一些坑","item":"https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/09-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"09-AntD框架的upload组件上传图片时遇到的一些坑","name":"09-AntD框架的upload组件上传图片时遇到的一些坑","description":"前言 本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。 前端做文件上传这个功能，是很有技术难度的。既然框架给我们提","keywords":["Ant Design"],"articleBody":"前言 本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 upload 组件。\n前端做文件上传这个功能，是很有技术难度的。既然框架给我们提供好了，那就直接用呗。结果用的时候，发现 upload 组件的很多bug。下面来列举几个。\n备注：本文写于2019-03-02，使用的 antd 版本是 3.13.6。\n使用 AntD 的 upload 组件做图片的上传 因为需要上传多张图片，所以采用的是照片墙的形式。上传成功后的界面如下：\n（1）上传中：\n（2）上传成功：\n（3）图片预览：\n按照官方提供的实例，特此整理出项目开发中的完整写法，亲测有效。代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 /* eslint-disable */ import { Upload, Icon, Modal, Form } from 'antd'; const FormItem = Form.Item; class PicturesWall extends PureComponent { state = { previewVisible: false, previewImage: '', imgList: [], }; handleChange = ({ file, fileList }) =\u003e { console.log(JSON.stringify(file)); // file 是当前正在上传的 单个 img console.log(JSON.stringify(fileList)); // fileList 是已上传的全部 img 列表 this.setState({ imgList: fileList, }); }; handleCancel = () =\u003e this.setState({ previewVisible: false }); handlePreview = file =\u003e { this.setState({ previewImage: file.url || file.thumbUrl, previewVisible: true, }); }; // 参考链接：https://www.jianshu.com/p/f356f050b3c9 handleBeforeUpload = file =\u003e { //限制图片 格式、size、分辨率 const isJPG = file.type === 'image/jpeg'; const isJPEG = file.type === 'image/jpeg'; const isGIF = file.type === 'image/gif'; const isPNG = file.type === 'image/png'; if (!(isJPG || isJPEG || isGIF || isPNG)) { Modal.error({ title: '只能上传JPG 、JPEG 、GIF、 PNG格式的图片~', }); return; } const isLt2M = file.size / 1024 / 1024 \u003c 2; if (!isLt2M) { Modal.error({ title: '超过2M限制，不允许上传~', }); return; } return (isJPG || isJPEG || isGIF || isPNG) \u0026\u0026 isLt2M \u0026\u0026 this.checkImageWH(file); }; //返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传 checkImageWH(file) { let self = this; return new Promise(function(resolve, reject) { let filereader = new FileReader(); filereader.onload = e =\u003e { let src = e.target.result; const image = new Image(); image.onload = function() { // 获取图片的宽高，并存放到file对象中 console.log('file width :' + this.width); console.log('file height :' + this.height); file.width = this.width; file.height = this.height; resolve(); }; image.onerror = reject; image.src = src; }; filereader.readAsDataURL(file); }); } handleSubmit = e =\u003e { const { dispatch, form } = this.props; e.preventDefault(); form.validateFieldsAndScroll((err, values) =\u003e {// values 是form表单里的参数 // 点击按钮后，将表单提交给后台 dispatch({ type: 'mymodel/submitFormData', payload: values, }); }); }; render() { const { previewVisible, previewImage, imgList } = this.state; // 从 state 中拿数据 const uploadButton = ( \u003cdiv\u003e \u003cIcon type=\"plus\" /\u003e \u003cdiv className=\"ant-upload-text\"\u003eUpload\u003c/div\u003e \u003c/div\u003e ); return ( \u003cdiv className=\"clearfix\"\u003e \u003cForm onSubmit={this.handleSubmit} hideRequiredMark style={{ marginTop: 8 }}\u003e \u003cFormItem label=\"图片图片\" {...formItemLayout}\u003e {getFieldDecorator('myImg')( \u003cUpload action=\"//jsonplaceholder.typicode.com/posts/\" // 这个是图片上传的接口请求，实际开发中，要替换成你自己的业务接口 data={file =\u003e ({ // data里存放的是接口的请求参数 param1: myParam1, param2: myParam2, photoCotent: file, // file 是当前正在上传的图片 photoWidth: file.height, // 通过 handleBeforeUpload 获取 图片的宽高 photoHeight: file.width, })} listType=\"picture-card\" fileList={this.state.imgList} onPreview={this.handlePreview} // 点击图片缩略图，进行预览 beforeUpload={this.handleBeforeUpload} // 上传之前，对图片的格式做校验，并获取图片的宽高 onChange={this.handleChange} // 每次上传图片时，都会触发这个方法 \u003e {this.state.imgList.length \u003e= 9 ? null : uploadButton} \u003c/Upload\u003e )} \u003c/FormItem\u003e \u003c/Form\u003e \u003cModal visible={previewVisible} footer={null} onCancel={this.handleCancel}\u003e \u003cimg alt=\"example\" style={{ width: '100%' }} src={previewImage} /\u003e \u003c/Modal\u003e \u003c/div\u003e ); } } export default PicturesWall; 上传后，点击图片预览，浏览器卡死的问题 依据上方的代码，通过 Antd 的 upload 组件将图片上传成功后，点击图片的缩略图，理应可以在当前页面弹出 Modal，预览图片。但实际的结果是，浏览器一定会卡死。\n定位问题发现，原因竟然是：图片上传成功后， upload 会将其转为 base64编码。base64这个字符串太大了，点击图片预览的时候，浏览器在解析一大串字符串，然后就卡死了。详细过程描述如下。\n上方代码中，我们可以把 handleChange(file, fileList)方法中的 file、以及 fileList打印出来看看。 file指的是当前正在上传的 单个 img，fileList是已上传的全部 img 列表。 当我上传完 两张图片后， 打印结果如下：\nfile的打印的结果如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 { \"uid\": \"rc-upload-1551084269812-5\", \"width\": 600, \"height\": 354, \"lastModified\": 1546701318000, \"lastModifiedDate\": \"2019-01-05T15:15:18.000Z\", \"name\": \"e30e7b9680634b2c888c8bb513cc595d.jpg\", \"size\": 31731, \"type\": \"image/jpeg\", \"percent\": 100, \"originFileObj\": { \"uid\": \"rc-upload-1551084269812-5\", \"width\": 600, \"height\": 354 }, \"status\": \"done\", \"thumbUrl\": \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z\", \"response\": { \"retCode\": 0, \"imgUrl\": \"http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg\", \"photoid\": 271850 } } fileList 的打印结果：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 [ { \"uid\": \"rc-upload-1551084269812-3\", \"width\": 1000, \"height\": 667, \"lastModified\": 1501414799000, \"lastModifiedDate\": \"2017-07-30T11:39:59.000Z\", \"name\": \"29381f30e924b89914e91b33.jpg\", \"size\": 135204, \"type\": \"image/jpeg\", \"percent\": 100, \"originFileObj\": { \"uid\": \"rc-upload-1551084269812-3\", \"width\": 1000, \"height\": 667 }, \"status\": \"done\", \"thumbUrl\": \"data:image/jpeg;base64,/E3ju1tlaK1fzJOnHQU3LsLV7HO6Zrk11MZJ7luT0A4FZuRagi9quvzQQ4iuEJ7ZpqTG4djDsPFl2Lg733f8C4q+YhQ8zoYfGSqoMmfwo5huLL0HjiyPDSYPvxRdC1XQvxeLrB8fvl/OnoLmL9vrdvvYS3NGFVe2YsASOh71JfQyrqV2mXLHOcccVSIYEnDyZO9XXB9KYH//Z\", \"response\": { \"retCode\": 0, \"msg\": \"success\", \"imgUrl\": \"http://qianguyihao.com/hfwpjouiurewnmbhepr689.jpg\", } }, { \"uid\": \"rc-upload-1551084269812-5\", \"width\": 600, \"height\": 354, \"lastModified\": 1546701318000, \"lastModifiedDate\": \"2019-01-05T15:15:18.000Z\", \"name\": \"e30e7b9680634b2c888c8bb513cc595d.jpg\", \"size\": 31731, \"type\": \"image/jpeg\", \"percent\": 100, \"originFileObj\": { \"uid\": \"rc-upload-1551084269812-5\", \"width\": 600, \"height\": 354 }, \"status\": \"done\", \"thumbUrl\": \"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z\", \"response\": { \"retCode\": 0, \"imgUrl\": \"http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg\", \"photoid\": 271850 } } ] 上方的json数据中，需要做几点解释：\n（1）response 字段里面的数据，就是请求接口后，后台返回给前端的数据，里面包含了图片的url链接。\n（2）status 字段里存放的是图片上传的实时状态，包括上传中、上传完成、上传失败。\n（3）thumbUrl字段里面存放的是图片的base64编码。\n这个base64编码非常非常长。当点击图片预览的时候，其实就是加载的 thumbUrl 这个字段里的资源，难怪浏览器会卡死。\n解决办法：在 handleChange方法里，图片上传成功后，将 thumbUrl 字段里面的 base64 编码改为真实的图片url。代码实现如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 handleChange = ({ file, fileList }) =\u003e { console.log(JSON.stringify(file)); // file 是当前正在上传的 单个 img console.log(JSON.stringify(fileList)); // fileList 是已上传的全部 img 列表 // 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。 // 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。 fileList.forEach(imgItem =\u003e { if (imgItem \u0026\u0026 imgItem.status == 'done' \u0026\u0026 imgItem.response \u0026\u0026 imgItem.response.imgUrl) { imgItem.thumbUrl = imgItem.response.imgUrl; } }); this.setState({ imgList: fileList, }); }; 新需求：编辑现有页面 上面一段的代码中，我们是在新建的页面中，从零开始上传图片。\n现在有个新的需求：如何编辑现有的页面呢？也就是说，现有的页面在初始化时，是默认有几张图片的。当我编辑这个页面时，可以对现有的图片做增删，也能增加新的图片。而且要保证：新建页面和编辑现有页面，是共用一套代码。\n我看到upload 组件有提供 defaultFileList 的属性。我试了下，这个defaultFileList 的属性根本没法儿用。\n那就只有手动实现了。我的model层代码，是用 redux 写的。整体的实现思路如下：（这个也是在真正在实战中用到的代码）\n（1）PicturesWall.js：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 /* eslint-disable */ import { Upload, Icon, Modal, Form } from 'antd'; const FormItem = Form.Item; class PicturesWall extends PureComponent { state = { previewVisible: false, previewImage: '', }; // 页面初始化的时候，从接口拉取默认的图片数据 componentDidMount() { const { dispatch } = this.props; dispatch({ type: 'mymodel/getAllInfo', payload: { params: xxx }, }); } handleChange = ({ file, fileList }) =\u003e { const { dispatch } = this.props; // 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。 // 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。 fileList.forEach(imgItem =\u003e { if (imgItem \u0026\u0026 imgItem.status == 'done' \u0026\u0026 imgItem.response \u0026\u0026 imgItem.response.imgUrl) { imgItem.thumbUrl = imgItem.response.imgUrl; } }); dispatch({ type: 'mymodel/setImgList', payload: fileList, }); }; handleCancel = () =\u003e this.setState({ previewVisible: false }); handlePreview = file =\u003e { this.setState({ previewImage: file.url || file.thumbUrl, previewVisible: true, }); }; // 参考链接：https://www.jianshu.com/p/f356f050b3c9 handleBeforeUpload = file =\u003e { //限制图片 格式、size、分辨率 const isJPG = file.type === 'image/jpeg'; const isJPEG = file.type === 'image/jpeg'; const isGIF = file.type === 'image/gif'; const isPNG = file.type === 'image/png'; const isLt2M = file.size / 1024 / 1024 \u003c 2; if (!(isJPG || isJPEG || isGIF || isPNG)) { Modal.error({ title: '只能上传JPG 、JPEG 、GIF、 PNG格式的图片~', }); } else if (!isLt2M) { Modal.error({ title: '超过2M限制，不允许上传~', }); } } // 参考链接：https://github.com/ant-design/ant-design/issues/8779 return new Promise((resolve, reject) =\u003e { if (!(isJPG || isJPEG || isGIF || isPNG)) { reject(file); } else { resolve(file \u0026\u0026 this.checkImageWH(file)); } }); }; //返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传 checkImageWH(file) { let self = this; return new Promise(function(resolve, reject) { let filereader = new FileReader(); filereader.onload = e =\u003e { let src = e.target.result; const image = new Image(); image.onload = function() { // 获取图片的宽高，并存放到file对象中 console.log('file width :' + this.width); console.log('file height :' + this.height); file.width = this.width; file.height = this.height; resolve(); }; image.onerror = reject; image.src = src; }; filereader.readAsDataURL(file); }); } handleSubmit = e =\u003e { const { dispatch, form } = this.props; e.preventDefault(); const { mymodel: { imgList }, // 从props中拿默认的图片数据 } = this.props; form.validateFieldsAndScroll((err, values) =\u003e { // values 是form表单里的参数 // 点击按钮后，将表单提交给后台 // start 问题描述：当编辑现有页面时，如果针对已经存在的默认图片不做修改，则不会触发 upload 的 onChange方法。此时提交表单，表单里的 myImg 字段是空的。 // 解决办法：如果发现存在默认图片，则追加到表单中 if (!values.myImg) { values.myImg = { fileList: [] }; values.myImg.fileList = imgList; } // end dispatch({ type: 'mymodel/submitFormData', payload: values, }); }); }; render() { const { previewVisible, previewImage } = this.state; // 从 state 中拿数据 const { mymodel: { imgList }, // 从props中拿到的图片数据 } = this.props; const uploadButton = ( \u003cdiv\u003e \u003cIcon type=\"plus\" /\u003e \u003cdiv className=\"ant-upload-text\"\u003eUpload\u003c/div\u003e \u003c/div\u003e ); return ( \u003cdiv className=\"clearfix\"\u003e \u003cForm onSubmit={this.handleSubmit} hideRequiredMark style={{ marginTop: 8 }}\u003e \u003cFormItem label=\"图片上传\" {...formItemLayout}\u003e {getFieldDecorator('myImg')( \u003cUpload action=\"//jsonplaceholder.typicode.com/posts/\" // 这个是图片上传的接口请求，实际开发中，要替换成你自己的业务接口 data={file =\u003e ({ // data里存放的是接口的请求参数 param1: myParam1, param2: myParam2, photoCotent: file, // file 是当前正在上传的图片 photoWidth: file.height, // 通过 handleBeforeUpload 获取 图片的宽高 photoHeight: file.width, })} listType=\"picture-card\" fileList={imgList} // 改为从 props 里拿图片数据，而不是从 state onPreview={this.handlePreview} // 点击图片缩略图，进行预览 beforeUpload={this.handleBeforeUpload} // 上传之前，对图片的格式做校验，并获取图片的宽高 onChange={this.handleChange} // 每次上传图片时，都会触发这个方法 \u003e {this.state.imgList.length \u003e= 9 ? null : uploadButton} \u003c/Upload\u003e )} \u003c/FormItem\u003e \u003c/Form\u003e \u003cModal visible={previewVisible} footer={null} onCancel={this.handleCancel}\u003e \u003cimg alt=\"example\" style={{ width: '100%' }} src={previewImage} /\u003e \u003c/Modal\u003e \u003c/div\u003e ); } } export default PicturesWall; （2）mymodel.js:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 /* eslint-disable */ import { routerRedux } from 'dva/router'; import { message, Modal } from 'antd'; import { getGoodsInfo, getAllGoods, } from '../services/api'; import { trim, getCookie } from '../utils/utils'; export default { namespace: 'mymodel', state: { form: {}, list: [], listDetail: [], goodsList: [], goodsListDetail: [], pagination: { pageSize: 10, total: 0, current: 1, }, imgList: [], //图片 }, subscriptions: { setup({ dispatch, history }) { history.listen(location =\u003e { if (location.pathname !== '/xx/xxx') return; if (!location.state || !location.state.xxxId) return; dispatch({ type: 'fetch', payload: location.state, }); }); }, }, effects: { // 接口。获取所有工厂店的列表 (步骤02) *getAllInfo({ payload }, { select, call, put }) { yield put({ type: 'form', payload, }); console.log('params:' + JSON.stringify(payload)); let params = {}; params = payload; const response = yield call(getGoodsInfo, params); console.log('smyhvae response:' + JSON.stringify(response)); if (response.error) return; yield put({ type: 'allInfo', payload: (response.data \u0026\u0026 response.data.map(item =\u003e ({ xx1: item.yy1, xx2: item.yy2, }))) || [], }); // response 里包含了接口返回给前端的默认图片数据 if (response \u0026\u0026 response.data \u0026\u0026 response.data[0] \u0026\u0026 response.data[0].my_jpg) { let tempImgList = response.data[0].my_jpg.split(','); let imgList = []; if (tempImgList.length \u003e 0) { tempImgList.forEach(item =\u003e { imgList.push({ uid: item, name: 'xxx.png', status: 'done', thumbUrl: item, }); }); } // 通过 redux的方式 将 默认图片 传给 imgList console.log('smyhvae payload imgList:' + JSON.stringify(imgList)); yield put({ type: 'setImgList', payload: imgList, }); } }, *setImgList({ payload }, { call, put }) { console.log('model setImgList'); yield put({ type: 'getImgList', payload, }); }, }, reducers: { allInfo(state, action) { return { ...state, list: action.payload, }; }, getImgList(state, action) { return { ...state, imgList: action.payload, }; }, }, }; 上面的代码，可以规避 upload 组件的一些bug；而且可以在上传前，通过校验图片的尺寸、大小等，如果不满足条件，则弹出modal弹窗，阻止上传。\n大功告成。本文感谢 ld 同学的支持。\n更多内容，可以看本人的另外一篇文章：\nAntD框架的upload组件上传图片时使用customRequest方法自定义上传行为 其他问题 beforeUpload返回false后，文件仍然为上传中的状态 最后一段 有人说，前端开发，连卖菜的都会。可如果真的遇到技术难题，还是得找个靠谱的前端同学才行。这不，来看看前端码农日常：\n","wordCount":"4299","inLanguage":"en","datePublished":"2020-01-01T17:11:35+08:00","dateModified":"2020-01-01T17:11:35+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://bablvsj.github.io/posts/tech/wait/12-react%E5%9F%BA%E7%A1%80/09-antd%E6%A1%86%E6%9E%B6%E7%9A%84upload%E7%BB%84%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9D%91/"},"publisher":{"@type":"Organization","name":"Bablvsj's Blog","logo":{"@type":"ImageObject","url":"https://bablvsj.github.io/img/Q.gif"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://bablvsj.github.io accesskey=h title="Bablvsj's Blog (Alt + H)">Bablvsj's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://bablvsj.github.io/ title=主页><span>主页</span></a></li><li><a href=https://bablvsj.github.io/archives/ title=时间轴><span>时间轴</span></a></li><li><a href=https://bablvsj.github.io/tags title=标签><span>标签</span></a></li><li><a href=https://bablvsj.github.io/about title=关于><span>关于</span></a></li><li><a href=https://bablvsj.github.io/search title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>09-AntD框架的upload组件上传图片时遇到的一些坑</h1><div class=post-meta><ul class=post-tags-meta><a href=https://bablvsj.github.io/tags/ant-design/>Ant Design</a></ul>9 min&nbsp;·&nbsp;<span title='2020-01-01 17:11:35 +0800 +0800'>2020/01/01</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><div class=inner><ul><li><a href=#%e5%89%8d%e8%a8%80 aria-label=前言>前言</a></li><li><a href=#%e4%bd%bf%e7%94%a8-antd-%e7%9a%84-upload-%e7%bb%84%e4%bb%b6%e5%81%9a%e5%9b%be%e7%89%87%e7%9a%84%e4%b8%8a%e4%bc%a0 aria-label="使用 AntD 的 upload 组件做图片的上传">使用 AntD 的 upload 组件做图片的上传</a></li><li><a href=#%e4%b8%8a%e4%bc%a0%e5%90%8e%e7%82%b9%e5%87%bb%e5%9b%be%e7%89%87%e9%a2%84%e8%a7%88%e6%b5%8f%e8%a7%88%e5%99%a8%e5%8d%a1%e6%ad%bb%e7%9a%84%e9%97%ae%e9%a2%98 aria-label=上传后，点击图片预览，浏览器卡死的问题>上传后，点击图片预览，浏览器卡死的问题</a></li><li><a href=#%e6%96%b0%e9%9c%80%e6%b1%82%e7%bc%96%e8%be%91%e7%8e%b0%e6%9c%89%e9%a1%b5%e9%9d%a2 aria-label=新需求：编辑现有页面>新需求：编辑现有页面</a></li><li><a href=#%e5%85%b6%e4%bb%96%e9%97%ae%e9%a2%98 aria-label=其他问题>其他问题</a></li><li><a href=#%e6%9c%80%e5%90%8e%e4%b8%80%e6%ae%b5 aria-label=最后一段>最后一段</a></li></ul></div></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h2 id=前言>前言<a hidden class=anchor aria-hidden=true href=#前言>#</a></h2><p>本次做后台管理系统，采用的是 AntD 框架。涉及到图片的上传，用的是AntD的 <a href=https://ant.design/components/upload-cn/>upload</a> 组件。</p><p>前端做文件上传这个功能，是很有技术难度的。既然框架给我们提供好了，那就直接用呗。结果用的时候，发现 upload 组件的很多bug。下面来列举几个。</p><p>备注：本文写于2019-03-02，使用的 antd 版本是 3.13.6。</p><h2 id=使用-antd-的-upload-组件做图片的上传>使用 AntD 的 upload 组件做图片的上传<a hidden class=anchor aria-hidden=true href=#使用-antd-的-upload-组件做图片的上传>#</a></h2><p>因为需要上传多张图片，所以采用的是照片墙的形式。上传成功后的界面如下：</p><p>（1）上传中：</p><p><img loading=lazy src=http://img.smyhvae.com/20190302_1335.png alt></p><p>（2）上传成功：</p><p><img loading=lazy src=http://img.smyhvae.com/20190302_1336.png alt></p><p>（3）图片预览：</p><p><img loading=lazy src=http://img.smyhvae.com/20190302_1331.png alt></p><p>按照官方提供的实例，特此整理出项目开发中的完整写法，亲测有效。代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=cm>/* eslint-disable */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Upload</span><span class=p>,</span> <span class=nx>Icon</span><span class=p>,</span> <span class=nx>Modal</span><span class=p>,</span> <span class=nx>Form</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;antd&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>FormItem</span> <span class=o>=</span> <span class=nx>Form</span><span class=p>.</span><span class=nx>Item</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>PicturesWall</span> <span class=kr>extends</span> <span class=nx>PureComponent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>previewImage</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>imgList</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>file</span><span class=p>,</span> <span class=nx>fileList</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>file</span><span class=p>));</span> <span class=c1>// file 是当前正在上传的 单个 img
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>fileList</span><span class=p>));</span> <span class=c1>// fileList 是已上传的全部 img 列表
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>imgList</span><span class=o>:</span> <span class=nx>fileList</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleCancel</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>false</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handlePreview</span> <span class=o>=</span> <span class=nx>file</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>previewImage</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>url</span> <span class=o>||</span> <span class=nx>file</span><span class=p>.</span><span class=nx>thumbUrl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 参考链接：https://www.jianshu.com/p/f356f050b3c9
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>handleBeforeUpload</span> <span class=o>=</span> <span class=nx>file</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//限制图片 格式、size、分辨率
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>isJPG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isJPEG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isGIF</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/gif&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isPNG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/png&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>isJPG</span> <span class=o>||</span> <span class=nx>isJPEG</span> <span class=o>||</span> <span class=nx>isGIF</span> <span class=o>||</span> <span class=nx>isPNG</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Modal</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;只能上传JPG 、JPEG 、GIF、 PNG格式的图片~&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isLt2M</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>size</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isLt2M</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Modal</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;超过2M限制，不允许上传~&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=nx>isJPG</span> <span class=o>||</span> <span class=nx>isJPEG</span> <span class=o>||</span> <span class=nx>isGIF</span> <span class=o>||</span> <span class=nx>isPNG</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nx>isLt2M</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>checkImageWH</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>checkImageWH</span><span class=p>(</span><span class=nx>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>filereader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FileReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>filereader</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=nx>e</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>src</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>image</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Image</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 获取图片的宽高，并存放到file对象中
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;file width :&#39;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>width</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;file height :&#39;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>file</span><span class=p>.</span><span class=nx>width</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>file</span><span class=p>.</span><span class=nx>height</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=nx>reject</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>filereader</span><span class=p>.</span><span class=nx>readAsDataURL</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleSubmit</span> <span class=o>=</span> <span class=nx>e</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>dispatch</span><span class=p>,</span> <span class=nx>form</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>e</span><span class=p>.</span><span class=nx>preventDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>form</span><span class=p>.</span><span class=nx>validateFieldsAndScroll</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>values</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span><span class=c1>// values 是form表单里的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 点击按钮后，将表单提交给后台
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>dispatch</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;mymodel/submitFormData&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>payload</span><span class=o>:</span> <span class=nx>values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>previewVisible</span><span class=p>,</span> <span class=nx>previewImage</span><span class=p>,</span> <span class=nx>imgList</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>;</span> <span class=c1>//  从 state 中拿数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>uploadButton</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Icon</span> <span class=nx>type</span><span class=o>=</span><span class=s2>&#34;plus&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>div</span> <span class=nx>className</span><span class=o>=</span><span class=s2>&#34;ant-upload-text&#34;</span><span class=o>&gt;</span><span class=nx>Upload</span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>div</span> <span class=nx>className</span><span class=o>=</span><span class=s2>&#34;clearfix&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Form</span> <span class=nx>onSubmit</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleSubmit</span><span class=p>}</span> <span class=nx>hideRequiredMark</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>marginTop</span><span class=o>:</span> <span class=mi>8</span> <span class=p>}}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>FormItem</span> <span class=nx>label</span><span class=o>=</span><span class=s2>&#34;图片图片&#34;</span> <span class=p>{...</span><span class=nx>formItemLayout</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>getFieldDecorator</span><span class=p>(</span><span class=s1>&#39;myImg&#39;</span><span class=p>)(</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;</span><span class=nx>Upload</span>
</span></span><span class=line><span class=cl>                <span class=nx>action</span><span class=o>=</span><span class=s2>&#34;//jsonplaceholder.typicode.com/posts/&#34;</span> <span class=c1>// 这个是图片上传的接口请求，实际开发中，要替换成你自己的业务接口
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>data</span><span class=o>=</span><span class=p>{</span><span class=nx>file</span> <span class=p>=&gt;</span> <span class=p>({</span> <span class=c1>// data里存放的是接口的请求参数
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=nx>param1</span><span class=o>:</span> <span class=nx>myParam1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nx>param2</span><span class=o>:</span> <span class=nx>myParam2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nx>photoCotent</span><span class=o>:</span> <span class=nx>file</span><span class=p>,</span> <span class=c1>// file 是当前正在上传的图片
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=nx>photoWidth</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>height</span><span class=p>,</span> <span class=c1>// 通过  handleBeforeUpload 获取 图片的宽高
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=nx>photoHeight</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>})}</span>
</span></span><span class=line><span class=cl>                <span class=nx>listType</span><span class=o>=</span><span class=s2>&#34;picture-card&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nx>fileList</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>imgList</span><span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=nx>onPreview</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handlePreview</span><span class=p>}</span> <span class=c1>// 点击图片缩略图，进行预览
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>beforeUpload</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleBeforeUpload</span><span class=p>}</span> <span class=c1>// 上传之前，对图片的格式做校验，并获取图片的宽高
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span> <span class=c1>// 每次上传图片时，都会触发这个方法
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=o>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>imgList</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;=</span> <span class=mi>9</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>uploadButton</span><span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;</span><span class=err>/Upload&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>)}</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=err>/FormItem&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/Form&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Modal</span> <span class=nx>visible</span><span class=o>=</span><span class=p>{</span><span class=nx>previewVisible</span><span class=p>}</span> <span class=nx>footer</span><span class=o>=</span><span class=p>{</span><span class=kc>null</span><span class=p>}</span> <span class=nx>onCancel</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleCancel</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>img</span> <span class=nx>alt</span><span class=o>=</span><span class=s2>&#34;example&#34;</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>width</span><span class=o>:</span> <span class=s1>&#39;100%&#39;</span> <span class=p>}}</span> <span class=nx>src</span><span class=o>=</span><span class=p>{</span><span class=nx>previewImage</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/Modal&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>PicturesWall</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=上传后点击图片预览浏览器卡死的问题>上传后，点击图片预览，浏览器卡死的问题<a hidden class=anchor aria-hidden=true href=#上传后点击图片预览浏览器卡死的问题>#</a></h2><p>依据上方的代码，通过 Antd 的 upload 组件将图片上传成功后，点击图片的缩略图，理应可以在当前页面弹出 Modal，预览图片。但实际的结果是，浏览器一定会卡死。</p><p>定位问题发现，原因竟然是：图片上传成功后， upload 会将其转为 base64编码。base64这个字符串太大了，点击图片预览的时候，浏览器在解析一大串字符串，然后就卡死了。详细过程描述如下。</p><p>上方代码中，我们可以把 handleChange(file, fileList)方法中的 <code>file</code>、以及 <code>fileList</code>打印出来看看。 <code>file</code>指的是当前正在上传的 单个 img，<code>fileList</code>是已上传的全部 img 列表。 当我上传完 两张图片后， 打印结果如下：</p><p>file的打印的结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;rc-upload-1551084269812-5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;width&#34;</span><span class=p>:</span> <span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;height&#34;</span><span class=p>:</span> <span class=mi>354</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;lastModified&#34;</span><span class=p>:</span> <span class=mi>1546701318000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;lastModifiedDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2019-01-05T15:15:18.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;e30e7b9680634b2c888c8bb513cc595d.jpg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>31731</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image/jpeg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;percent&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;originFileObj&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;rc-upload-1551084269812-5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;width&#34;</span><span class=p>:</span> <span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;height&#34;</span><span class=p>:</span> <span class=mi>354</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;done&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;thumbUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;response&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;retCode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;imgUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;photoid&#34;</span><span class=p>:</span> <span class=mi>271850</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>fileList 的打印结果：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;rc-upload-1551084269812-3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;width&#34;</span><span class=p>:</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;height&#34;</span><span class=p>:</span> <span class=mi>667</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;lastModified&#34;</span><span class=p>:</span> <span class=mi>1501414799000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;lastModifiedDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2017-07-30T11:39:59.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;29381f30e924b89914e91b33.jpg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>135204</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image/jpeg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;percent&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;originFileObj&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;rc-upload-1551084269812-3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;width&#34;</span><span class=p>:</span> <span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;height&#34;</span><span class=p>:</span> <span class=mi>667</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;done&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;thumbUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;data:image/jpeg;base64,/E3ju1tlaK1fzJOnHQU3LsLV7HO6Zrk11MZJ7luT0A4FZuRagi9quvzQQ4iuEJ7ZpqTG4djDsPFl2Lg733f8C4q+YhQ8zoYfGSqoMmfwo5huLL0HjiyPDSYPvxRdC1XQvxeLrB8fvl/OnoLmL9vrdvvYS3NGFVe2YsASOh71JfQyrqV2mXLHOcccVSIYEnDyZO9XXB9KYH//Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;response&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;retCode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;msg&#34;</span><span class=p>:</span> <span class=s2>&#34;success&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;imgUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;http://qianguyihao.com/hfwpjouiurewnmbhepr689.jpg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;rc-upload-1551084269812-5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;width&#34;</span><span class=p>:</span> <span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;height&#34;</span><span class=p>:</span> <span class=mi>354</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;lastModified&#34;</span><span class=p>:</span> <span class=mi>1546701318000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;lastModifiedDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2019-01-05T15:15:18.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;e30e7b9680634b2c888c8bb513cc595d.jpg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;size&#34;</span><span class=p>:</span> <span class=mi>31731</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;image/jpeg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;percent&#34;</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;originFileObj&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;uid&#34;</span><span class=p>:</span> <span class=s2>&#34;rc-upload-1551084269812-5&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;width&#34;</span><span class=p>:</span> <span class=mi>600</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;height&#34;</span><span class=p>:</span> <span class=mi>354</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=s2>&#34;done&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;thumbUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAHQ9qKKlbimcXrIH9o2vH/AC2T+ddPj98v+9RRWsuhnHdk0ar9qb5R0Pb6VPB/qh9aKKiRr0Irnt/vUDr+NFFJCRqWxJik5Pb+dLJ938aKK06mYSdKKKKBH//Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;response&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;retCode&#34;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;imgUrl&#34;</span><span class=p>:</span> <span class=s2>&#34;http://qianguyihao.com/opfewfwj098902kpkpkkj976fe.jpg&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;photoid&#34;</span><span class=p>:</span> <span class=mi>271850</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p>上方的json数据中，需要做几点解释：</p><p>（1）<code>response</code> 字段里面的数据，就是请求接口后，后台返回给前端的数据，里面包含了图片的url链接。</p><p>（2）<code>status</code> 字段里存放的是图片上传的实时状态，包括上传中、上传完成、上传失败。</p><p>（3）<code>thumbUrl</code>字段里面存放的是图片的base64编码。</p><p>这个base64编码非常非常长。当点击图片预览的时候，其实就是加载的 thumbUrl 这个字段里的资源，难怪浏览器会卡死。</p><p><strong>解决办法</strong>：在 handleChange方法里，图片上传成功后，将 thumbUrl 字段里面的 base64 编码改为真实的图片url。代码实现如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>file</span><span class=p>,</span> <span class=nx>fileList</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>file</span><span class=p>));</span> <span class=c1>// file 是当前正在上传的 单个 img
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>fileList</span><span class=p>));</span> <span class=c1>// fileList 是已上传的全部 img 列表
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fileList</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>imgItem</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>imgItem</span> <span class=o>&amp;&amp;</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>status</span> <span class=o>==</span> <span class=s1>&#39;done&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>response</span> <span class=o>&amp;&amp;</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>imgUrl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>imgItem</span><span class=p>.</span><span class=nx>thumbUrl</span> <span class=o>=</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>imgUrl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>imgList</span><span class=o>:</span> <span class=nx>fileList</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=新需求编辑现有页面>新需求：编辑现有页面<a hidden class=anchor aria-hidden=true href=#新需求编辑现有页面>#</a></h2><p>上面一段的代码中，我们是在新建的页面中，从零开始上传图片。</p><p>现在有个新的需求：如何编辑现有的页面呢？也就是说，现有的页面在初始化时，是默认有几张图片的。当我编辑这个页面时，可以对现有的图片做增删，也能增加新的图片。而且要保证：新建页面和编辑现有页面，是共用一套代码。</p><p>我看到upload 组件有提供 <code>defaultFileList</code> 的属性。我试了下，这个<code>defaultFileList</code> 的属性根本没法儿用。</p><p>那就只有手动实现了。我的model层代码，是用 redux 写的。整体的实现思路如下：（这个也是在真正在实战中用到的代码）</p><p>（1）PicturesWall.js：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=cm>/* eslint-disable */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Upload</span><span class=p>,</span> <span class=nx>Icon</span><span class=p>,</span> <span class=nx>Modal</span><span class=p>,</span> <span class=nx>Form</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;antd&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>FormItem</span> <span class=o>=</span> <span class=nx>Form</span><span class=p>.</span><span class=nx>Item</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>PicturesWall</span> <span class=kr>extends</span> <span class=nx>PureComponent</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>state</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>previewImage</span><span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 页面初始化的时候，从接口拉取默认的图片数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>componentDidMount</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>dispatch</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>dispatch</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;mymodel/getAllInfo&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>payload</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span><span class=o>:</span> <span class=nx>xxx</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleChange</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>file</span><span class=p>,</span> <span class=nx>fileList</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>dispatch</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 【重要】将 图片的base64替换为图片的url。 这一行一定不会能少。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 图片上传成功后，fileList数组中的 thumbUrl 中保存的是图片的base64字符串，这种情况，导致的问题是：图片上传成功后，点击图片缩略图，浏览器会会卡死。而下面这行代码，可以解决该bug。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fileList</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>imgItem</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>imgItem</span> <span class=o>&amp;&amp;</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>status</span> <span class=o>==</span> <span class=s1>&#39;done&#39;</span> <span class=o>&amp;&amp;</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>response</span> <span class=o>&amp;&amp;</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>imgUrl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>imgItem</span><span class=p>.</span><span class=nx>thumbUrl</span> <span class=o>=</span> <span class=nx>imgItem</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>imgUrl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>dispatch</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;mymodel/setImgList&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>payload</span><span class=o>:</span> <span class=nx>fileList</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleCancel</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span> <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>false</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handlePreview</span> <span class=o>=</span> <span class=nx>file</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>setState</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>previewImage</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>url</span> <span class=o>||</span> <span class=nx>file</span><span class=p>.</span><span class=nx>thumbUrl</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>previewVisible</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 参考链接：https://www.jianshu.com/p/f356f050b3c9
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>handleBeforeUpload</span> <span class=o>=</span> <span class=nx>file</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//限制图片 格式、size、分辨率
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>isJPG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isJPEG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/jpeg&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isGIF</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/gif&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isPNG</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>type</span> <span class=o>===</span> <span class=s1>&#39;image/png&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>isLt2M</span> <span class=o>=</span> <span class=nx>file</span><span class=p>.</span><span class=nx>size</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>isJPG</span> <span class=o>||</span> <span class=nx>isJPEG</span> <span class=o>||</span> <span class=nx>isGIF</span> <span class=o>||</span> <span class=nx>isPNG</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Modal</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;只能上传JPG 、JPEG 、GIF、 PNG格式的图片~&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isLt2M</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>Modal</span><span class=p>.</span><span class=nx>error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>title</span><span class=o>:</span> <span class=s1>&#39;超过2M限制，不允许上传~&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 参考链接：https://github.com/ant-design/ant-design/issues/8779
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>((</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=nx>isJPG</span> <span class=o>||</span> <span class=nx>isJPEG</span> <span class=o>||</span> <span class=nx>isGIF</span> <span class=o>||</span> <span class=nx>isPNG</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>reject</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>resolve</span><span class=p>(</span><span class=nx>file</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=nx>checkImageWH</span><span class=p>(</span><span class=nx>file</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>//返回一个 promise：检测通过则返回resolve；失败则返回reject，并阻止图片上传
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>checkImageWH</span><span class=p>(</span><span class=nx>file</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>self</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nb>Promise</span><span class=p>(</span><span class=kd>function</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>reject</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>filereader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FileReader</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=nx>filereader</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=nx>e</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>src</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>target</span><span class=p>.</span><span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>image</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Image</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>onload</span> <span class=o>=</span> <span class=kd>function</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 获取图片的宽高，并存放到file对象中
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;file width :&#39;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>width</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;file height :&#39;</span> <span class=o>+</span> <span class=k>this</span><span class=p>.</span><span class=nx>height</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nx>file</span><span class=p>.</span><span class=nx>width</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>width</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>file</span><span class=p>.</span><span class=nx>height</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>height</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nx>resolve</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>onerror</span> <span class=o>=</span> <span class=nx>reject</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>image</span><span class=p>.</span><span class=nx>src</span> <span class=o>=</span> <span class=nx>src</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=nx>filereader</span><span class=p>.</span><span class=nx>readAsDataURL</span><span class=p>(</span><span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>handleSubmit</span> <span class=o>=</span> <span class=nx>e</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>dispatch</span><span class=p>,</span> <span class=nx>form</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>e</span><span class=p>.</span><span class=nx>preventDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>mymodel</span><span class=o>:</span> <span class=p>{</span> <span class=nx>imgList</span> <span class=p>},</span> <span class=c1>// 从props中拿默认的图片数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>form</span><span class=p>.</span><span class=nx>validateFieldsAndScroll</span><span class=p>((</span><span class=nx>err</span><span class=p>,</span> <span class=nx>values</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// values 是form表单里的参数
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 点击按钮后，将表单提交给后台
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// start 问题描述：当编辑现有页面时，如果针对已经存在的默认图片不做修改，则不会触发 upload 的 onChange方法。此时提交表单，表单里的 myImg 字段是空的。
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 解决办法：如果发现存在默认图片，则追加到表单中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>values</span><span class=p>.</span><span class=nx>myImg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>values</span><span class=p>.</span><span class=nx>myImg</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>fileList</span><span class=o>:</span> <span class=p>[]</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>values</span><span class=p>.</span><span class=nx>myImg</span><span class=p>.</span><span class=nx>fileList</span> <span class=o>=</span> <span class=nx>imgList</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// end
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=nx>dispatch</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;mymodel/submitFormData&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>payload</span><span class=o>:</span> <span class=nx>values</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>render</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>previewVisible</span><span class=p>,</span> <span class=nx>previewImage</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>;</span> <span class=c1>//  从 state 中拿数据
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>mymodel</span><span class=o>:</span> <span class=p>{</span> <span class=nx>imgList</span> <span class=p>},</span> <span class=c1>// 从props中拿到的图片数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>props</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>uploadButton</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>div</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Icon</span> <span class=nx>type</span><span class=o>=</span><span class=s2>&#34;plus&#34;</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>div</span> <span class=nx>className</span><span class=o>=</span><span class=s2>&#34;ant-upload-text&#34;</span><span class=o>&gt;</span><span class=nx>Upload</span><span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=nx>div</span> <span class=nx>className</span><span class=o>=</span><span class=s2>&#34;clearfix&#34;</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Form</span> <span class=nx>onSubmit</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleSubmit</span><span class=p>}</span> <span class=nx>hideRequiredMark</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>marginTop</span><span class=o>:</span> <span class=mi>8</span> <span class=p>}}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>FormItem</span> <span class=nx>label</span><span class=o>=</span><span class=s2>&#34;图片上传&#34;</span> <span class=p>{...</span><span class=nx>formItemLayout</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>getFieldDecorator</span><span class=p>(</span><span class=s1>&#39;myImg&#39;</span><span class=p>)(</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;</span><span class=nx>Upload</span>
</span></span><span class=line><span class=cl>                <span class=nx>action</span><span class=o>=</span><span class=s2>&#34;//jsonplaceholder.typicode.com/posts/&#34;</span> <span class=c1>// 这个是图片上传的接口请求，实际开发中，要替换成你自己的业务接口
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>data</span><span class=o>=</span><span class=p>{</span><span class=nx>file</span> <span class=p>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>                  <span class=c1>// data里存放的是接口的请求参数
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=nx>param1</span><span class=o>:</span> <span class=nx>myParam1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nx>param2</span><span class=o>:</span> <span class=nx>myParam2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=nx>photoCotent</span><span class=o>:</span> <span class=nx>file</span><span class=p>,</span> <span class=c1>// file 是当前正在上传的图片
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=nx>photoWidth</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>height</span><span class=p>,</span> <span class=c1>// 通过  handleBeforeUpload 获取 图片的宽高
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=nx>photoHeight</span><span class=o>:</span> <span class=nx>file</span><span class=p>.</span><span class=nx>width</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>})}</span>
</span></span><span class=line><span class=cl>                <span class=nx>listType</span><span class=o>=</span><span class=s2>&#34;picture-card&#34;</span>
</span></span><span class=line><span class=cl>                <span class=nx>fileList</span><span class=o>=</span><span class=p>{</span><span class=nx>imgList</span><span class=p>}</span>  <span class=c1>// 改为从 props 里拿图片数据，而不是从 state
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>onPreview</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handlePreview</span><span class=p>}</span> <span class=c1>// 点击图片缩略图，进行预览
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>beforeUpload</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleBeforeUpload</span><span class=p>}</span> <span class=c1>// 上传之前，对图片的格式做校验，并获取图片的宽高
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=nx>onChange</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleChange</span><span class=p>}</span> <span class=c1>// 每次上传图片时，都会触发这个方法
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=o>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>imgList</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;=</span> <span class=mi>9</span> <span class=o>?</span> <span class=kc>null</span> <span class=o>:</span> <span class=nx>uploadButton</span><span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=o>&lt;</span><span class=err>/Upload&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>)}</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=err>/FormItem&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/Form&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=nx>Modal</span> <span class=nx>visible</span><span class=o>=</span><span class=p>{</span><span class=nx>previewVisible</span><span class=p>}</span> <span class=nx>footer</span><span class=o>=</span><span class=p>{</span><span class=kc>null</span><span class=p>}</span> <span class=nx>onCancel</span><span class=o>=</span><span class=p>{</span><span class=k>this</span><span class=p>.</span><span class=nx>handleCancel</span><span class=p>}</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=o>&lt;</span><span class=nx>img</span> <span class=nx>alt</span><span class=o>=</span><span class=s2>&#34;example&#34;</span> <span class=nx>style</span><span class=o>=</span><span class=p>{{</span> <span class=nx>width</span><span class=o>:</span> <span class=s1>&#39;100%&#39;</span> <span class=p>}}</span> <span class=nx>src</span><span class=o>=</span><span class=p>{</span><span class=nx>previewImage</span><span class=p>}</span> <span class=o>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=o>&lt;</span><span class=err>/Modal&gt;</span>
</span></span><span class=line><span class=cl>      <span class=o>&lt;</span><span class=err>/div&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>PicturesWall</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>（2）mymodel.js:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=cm>/* eslint-disable */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>routerRedux</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;dva/router&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>message</span><span class=p>,</span> <span class=nx>Modal</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;antd&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>getGoodsInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>getAllGoods</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../services/api&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>trim</span><span class=p>,</span> <span class=nx>getCookie</span> <span class=p>}</span> <span class=nx>from</span> <span class=s1>&#39;../utils/utils&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>namespace</span><span class=o>:</span> <span class=s1>&#39;mymodel&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>state</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>form</span><span class=o>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>    <span class=nx>list</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>listDetail</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>goodsList</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>goodsListDetail</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>    <span class=nx>pagination</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>pageSize</span><span class=o>:</span> <span class=mi>10</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>total</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>current</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>imgList</span><span class=o>:</span> <span class=p>[],</span> <span class=c1>//图片
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>subscriptions</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setup</span><span class=p>({</span> <span class=nx>dispatch</span><span class=p>,</span> <span class=nx>history</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>history</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>location</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>location</span><span class=p>.</span><span class=nx>pathname</span> <span class=o>!==</span> <span class=s1>&#39;/xx/xxx&#39;</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>location</span><span class=p>.</span><span class=nx>state</span> <span class=o>||</span> <span class=o>!</span><span class=nx>location</span><span class=p>.</span><span class=nx>state</span><span class=p>.</span><span class=nx>xxxId</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>dispatch</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;fetch&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>payload</span><span class=o>:</span> <span class=nx>location</span><span class=p>.</span><span class=nx>state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>effects</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 接口。获取所有工厂店的列表 (步骤02)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>*</span><span class=nx>getAllInfo</span><span class=p>({</span> <span class=nx>payload</span> <span class=p>},</span> <span class=p>{</span> <span class=nx>select</span><span class=p>,</span> <span class=nx>call</span><span class=p>,</span> <span class=nx>put</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>put</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;form&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;params:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>payload</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kd>let</span> <span class=nx>params</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>      <span class=nx>params</span> <span class=o>=</span> <span class=nx>payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=k>yield</span> <span class=nx>call</span><span class=p>(</span><span class=nx>getGoodsInfo</span><span class=p>,</span> <span class=nx>params</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae response:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>response</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>error</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>put</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;allInfo&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>payload</span><span class=o>:</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>            <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>xx1</span><span class=o>:</span> <span class=nx>item</span><span class=p>.</span><span class=nx>yy1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>xx2</span><span class=o>:</span> <span class=nx>item</span><span class=p>.</span><span class=nx>yy2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>})))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>          <span class=p>[],</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// response 里包含了接口返回给前端的默认图片数据
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nx>response</span> <span class=o>&amp;&amp;</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span> <span class=o>&amp;&amp;</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&amp;&amp;</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>my_jpg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>tempImgList</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>my_jpg</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>let</span> <span class=nx>imgList</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>tempImgList</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>tempImgList</span><span class=p>.</span><span class=nx>forEach</span><span class=p>(</span><span class=nx>item</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>imgList</span><span class=p>.</span><span class=nx>push</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>uid</span><span class=o>:</span> <span class=nx>item</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;xxx.png&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>status</span><span class=o>:</span> <span class=s1>&#39;done&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>thumbUrl</span><span class=o>:</span> <span class=nx>item</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过  redux的方式 将 默认图片 传给 imgList
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;smyhvae payload imgList:&#39;</span> <span class=o>+</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>imgList</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>yield</span> <span class=nx>put</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;setImgList&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>payload</span><span class=o>:</span> <span class=nx>imgList</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=nx>setImgList</span><span class=p>({</span> <span class=nx>payload</span> <span class=p>},</span> <span class=p>{</span> <span class=nx>call</span><span class=p>,</span> <span class=nx>put</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;model setImgList&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>yield</span> <span class=nx>put</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;getImgList&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>reducers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>allInfo</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>action</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>list</span><span class=o>:</span> <span class=nx>action</span><span class=p>.</span><span class=nx>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>getImgList</span><span class=p>(</span><span class=nx>state</span><span class=p>,</span> <span class=nx>action</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>state</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>imgList</span><span class=o>:</span> <span class=nx>action</span><span class=p>.</span><span class=nx>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>上面的代码，可以规避 upload 组件的一些bug；而且可以在上传前，通过校验图片的尺寸、大小等，如果不满足条件，则弹出modal弹窗，阻止上传。</p><p>大功告成。本文感谢 ld 同学的支持。</p><p>更多内容，可以看本人的另外一篇文章：</p><ul><li><a href=https://www.cnblogs.com/qianguyihao/p/13093592.html>AntD框架的upload组件上传图片时使用customRequest方法自定义上传行为</a></li></ul><h2 id=其他问题>其他问题<a hidden class=anchor aria-hidden=true href=#其他问题>#</a></h2><ul><li><a href=https://github.com/ant-design/ant-design/issues/8779>beforeUpload返回false后，文件仍然为上传中的状态</a></li></ul><h2 id=最后一段>最后一段<a hidden class=anchor aria-hidden=true href=#最后一段>#</a></h2><p>有人说，前端开发，连卖菜的都会。可如果真的遇到技术难题，还是得找个靠谱的前端同学才行。这不，来看看前端码农日常：</p><p><img loading=lazy src=http://img.smyhvae.com/20190302_1339_2.png alt></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://bablvsj.github.io/tags/ant-design/>Ant Design</a></li></ul><nav class=paginav><a class=prev href=https://bablvsj.github.io/posts/tech/wait/04-javascript/08-%E8%BF%90%E7%AE%97%E7%AC%A6/><span class=title>« Prev</span><br><span>08-运算符</span></a>
<a class=next href=https://bablvsj.github.io/posts/tech/wait/04-javascript/09-%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1%E6%89%A9%E5%B1%95set%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/><span class=title>Next »</span><br><span>09-内置对象扩展：Set数据结构</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://bablvsj.github.io>Bablvsj's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span><div class=flex-c-d><a class=flex-d-c href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target=_blank><span>本站由</span><img width=60 src=/images/upyun.png>提供CDN加速/云存储服务</a></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>